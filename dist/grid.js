define("kjui/grid/1.3.0/grid",["$","arale/widget/1.0.3/widget","arale/base/1.0.1/base","arale/class/1.0.0/class","arale/events/1.0.0/events","arale/widget/1.0.3/templatable","gallery/handlebars/1.0.0/handlebars","gallery/underscore/1.4.4/underscore","./loading","./loading.tpl","./grid.tpl","./extraHeaderTd.tpl","./headerTd.tpl","./body.tpl"],function(e,t,a){var i=e("$"),s=e("arale/widget/1.0.3/widget"),r=e("arale/widget/1.0.3/templatable"),d=e("gallery/handlebars/1.0.0/handlebars"),n=e("gallery/underscore/1.4.4/underscore"),l=e("./loading"),o=s.extend({Implements:r,attrs:{url:"",urlParser:null,data:[]},template:e("./grid.tpl"),model:{fields:[],title:"",paginate:!0,needCheckbox:!1,checkboxWidth:30,needOrder:!1,orderWidth:30,width:null,height:null},parseElement:function(){n.defaults(this.model,{width:i(this.get("parentNode")).innerWidth(),records:[],isFirst:!0,isLast:!0,hasPrev:!1,hasNext:!1,totalCount:0,pageSize:0,pageNumbers:0}),this.model.headers=this._processHeaders(),this.model.fields=this._processFields(),o.superclass.parseElement.call(this)},_processHeaders:function(){function e(t,s){s+1>a.length?a.push(t):a[s]=a[s].concat(t);var r=s+1;i.each(t,function(){this.children&&this.children.length>0&&e(this.children,r)})}function t(e,a){for(var i=a+e.length,s=0;e.length>s;s++){var r=e[s];r.children&&r.children.length>0&&(i=t(r.children,i-1))}return i}var a=[];e(this.model.fields,0);for(var s=a.length,r=0;s>r;r++)for(var d=a[r],n=0;d.length>n;n++){var l=d[n];if(l.children&&l.children.length>0){var o=0;o=t(l.children,o),l.colspan=o}else s>1&&(l.rowspan=s-r),1==l.rowspan&&delete l.rowspan}return a},_processFields:function(){function e(r){i.each(r,function(){this.children&&this.children.length>0?e(this.children):(s.push(this),this.width&&(t+=this.width,a+=1))})}var t=0,a=0,s=[];e(this.model.fields);var r=18;a===s.length&&t>this.model.width&&(this.model.isLong=!0,r=0);var d=this.model.width-t-r;this.model.needCheckbox&&(d-=this.model.checkboxWidth),this.model.needOrder&&(d-=this.model.orderWidth);for(var n=d/(s.length-a),l=s.length-1;l>=0;l--)s[l].width||(s[l].width=n);return s},templateHelpers:{createHeader:function(){var t=i.extend({},this,{needRowspan:this.headers.length>1,rowspan:this.headers.length}),a=d.compile(e("./extraHeaderTd.tpl"))(t),s="<tr>"+a,r=e("./headerTd.tpl");d.registerHelper("addSortClass",function(e){return"asc"==e||"desc"==e?new d.SafeString(" grid-is-"+e):void 0});var n=d.compile(r)({headers:this.headers[0]});s+=n+"</tr>";for(var l=1;this.headers.length>l;l++)s+="<tr>",n=d.compile(r)({headers:this.headers[l]}),s+=n+"</tr>";return new d.SafeString(s)}},setup:function(){var e=this;this.model.isLong&&this.$(".grid-view").scroll(function(){e.$(".grid-hd").scrollLeft(i(this).scrollLeft())})},_onRenderUrl:function(e){var t=this;this.showLoading(),i.getJSON(e,function(e){t._loadData(e.data),t.hideLoading()})},_onRenderData:function(e){this._loadData(e)},_loadData:function(t){var a=this;this.data=t;var s=i.map(t.result,function(e,s){var r="";return a.model.needOrder&&(r=(t.pageNumber-1)*t.pageSize+s+1),{isAlt:1===s%2,order:r,values:i.map(a.model.fields,function(t){var a=e[t.name];a=n.escape(a),i.isFunction(t.render)&&(a=t.render(a));var s=n.clone(t);return s.value=a,s})}}),r=d.compile(e("./body.tpl"))(i.extend({},this.model,{records:s}));this.$(".grid-view tbody").html(r),i.extend(this.model,{isFirst:function(){return 1>=t.pageNumber},isLast:function(){return 0===t.totalPages||t.pageNumber===t.totalPages},hasPrev:t.hasPrev,hasNext:t.hasNext,totalCount:t.totalCount,pageSize:t.pageSize,pageNumbers:function(){return Math.ceil(t.totalCount/t.pageSize)}}),this.renderPartial(".toolbar-ft");var l=this.$(".grid-row");i.each(t.result,function(e,t){l.eq(e).data("data",t)}),this.selected=this.model.needCheckbox?[]:null;var o=this.$("[data-role=checkAll]");o.length>0&&(o[0].indeterminate=!1,o.prop("checked",!1)),this.$("[data-role=num]").val(t.pageNumber),this.$("i").click(function(e){/disabled/.test(e.target.className)&&e.stopImmediatePropagation()}),this.trigger("loaded")},events:{"click .grid-hd":"_sort","click .grid-row":"_click","click [data-role=check]":"_check","click [data-role=checkAll]":"_checkAll","click [data-role=prev]":"prevPage","click [data-role=next]":"nextPage","click [data-role=first]":"firstPage","click [data-role=last]":"lastPage","click [data-role=refresh]":"refresh","keyup [data-role=num]":"_gotoPage"},_sort:function(e){var t=i(e.target).closest("td");if(t.hasClass("grid-is-sortable")){var a=t.attr("data-name");this._oldSortHeader?this._oldSortHeader.attr("data-name")!==a&&(this._oldSortHeader.removeClass("grid-is-desc grid-is-asc"),this._oldSortHeader=t):this._oldSortHeader=t,t.hasClass("grid-is-desc")?(t.removeClass("grid-is-desc").addClass("grid-is-asc"),this.trigger("sort",a,"asc")):(t.removeClass("grid-is-asc").addClass("grid-is-desc"),this.trigger("sort",a,"desc"))}},_click:function(e){var t=i(e.target),a=t.parents("tr"),s=a.data("data");this.model.needCheckbox||(this.selected&&this.selected.data("data").id===s.id?(this.selected=null,a.removeClass("grid-row-is-selected")):(this.selected=a,a.addClass("grid-row-is-selected").siblings().removeClass("grid-row-is-selected"))),"check"!=t.attr("data-role")&&this.trigger("click",t,s)},_check:function(e){var t=i(e.target),a=t.parents("tr"),s=i("[data-role=checkAll]");if(s[0].indeterminate=!0,t.prop("checked"))this.selected.push(a),a.addClass("grid-row-is-selected"),0===i("[data-role=check]").not(":checked").length&&(s[0].indeterminate=!1,s.prop("checked",!0));else{for(var r=a.data("data").id,d=this.selected.length-1;d>=0;d--)this.selected[d].data("data").id===r&&this.selected.splice(d,1);a.removeClass("grid-row-is-selected"),i("[data-role=check]").is(":checked")||(s[0].indeterminate=!1,s.prop("checked",!1))}},_checkAll:function(e){var t=i(e.target),a=this.$("[data-role=check]"),s=a.parents("tr");if(t.prop("checked")){var r=[];s.each(function(e,t){r.push(i(t))}),this.selected=r,a.prop("checked",!0),s.addClass("grid-row-is-selected")}else this.selected=[],a.prop("checked",!1),s.removeClass("grid-row-is-selected")},_gotoPage:function(e){var t=i(e.target),a=t.val();if(a&&13==e.which)this.gotoPage(a);else if(a=a.replace(/\D/g,"")){a=parseInt(a,10);var s=this.data.totalPages;a>s?a=s:0===a&&(a=1),t.val(a)}else t.val("")},gotoPage:function(e){var t=this.get("urlParser"),a=this.get("url").replace(t,"$1"+e+"$2");this.set("url",a)},prevPage:function(){var e=this.data.prevPage;this.gotoPage(e)},nextPage:function(){var e=this.data.nextPage;this.gotoPage(e)},firstPage:function(){var e=this.data.firstPage;this.gotoPage(e)},lastPage:function(){var e=this.data.lastPage;this.gotoPage(e)},refresh:function(){var e=this.get("url");this._onRenderUrl(e)},showLoading:function(){this.loading?this.loading.element.show():this.loading=new l({parentNode:this.$(".grid-bd"),model:{left:(this.model.width-106)/2,top:(this.model.height-36)/2}}).render()},hideLoading:function(){this.loading.element.hide()}});a.exports=o}),define("kjui/grid/1.3.0/loading",["$","arale/widget/1.0.3/widget","arale/base/1.0.1/base","arale/class/1.0.0/class","arale/events/1.0.0/events","arale/widget/1.0.3/templatable","gallery/handlebars/1.0.0/handlebars"],function(e,t,a){var i=(e("$"),e("arale/widget/1.0.3/widget")),s=e("arale/widget/1.0.3/templatable"),r=i.extend({Implements:s,template:e("kjui/grid/1.3.0/loading.tpl"),model:{left:0,top:0,content:"加载中..."}});a.exports=r}),define("kjui/grid/1.3.0/loading.tpl",[],'<div class="mask">\n  <div class="mask-bg"></div>\n  <div class="mask-msg" style="left:{{left}}px;top:{{top}}px;">\n    <div class="loading">{{content}}</div>\n  </div>\n</div>\n'),define("kjui/grid/1.3.0/grid.tpl",[],'<div class="panel-mod" style="width:{{width}}px;">\n  {{#if title}}\n  <div class="panel-hd">\n    <span>{{title}}</span>\n  </div>\n  {{/if}}\n  <div class="panel-bd">\n\n    <div class="grid-hd">\n      <table>\n        <thead>\n          <tr>\n            {{#if needCheckbox}}\n              <th style="width:{{checkboxWidth}}px;"></th>\n            {{/if}}\n            {{#if needOrder}}\n              <th style="width:{{orderWidth}}px;"></th>\n            {{/if}}\n            {{#each fields}}\n              <th style="width:{{width}}px;"></th>\n            {{/each}}\n            <th style="width:18px;"></th>\n            <th></th>\n          </tr>\n        </thead>\n        <tbody>\n          {{createHeader headers}}\n        </tbody>\n      </table>\n    </div>\n\n    <div class="grid-bd" style="height:{{height}}px;">\n      <div class="grid-view"{{#unless isLong}} style="_overflow-x:hidden;"{{/unless}}>\n        <table>\n          <thead>\n            <tr>\n              {{#if needCheckbox}}\n                <th style="width:{{checkboxWidth}}px;"></th>\n              {{/if}}\n              {{#if needOrder}}\n                <th style="width:{{orderWidth}}px;"></th>\n              {{/if}}\n              {{#each fields}}\n                <th style="width:{{width}}px;"></th>\n              {{/each}}\n              <th></th>\n            </tr>\n          </thead>\n          <tbody></tbody>\n        </table>\n      </div>\n    </div>\n\n    {{#if paginate}}\n      <div class="toolbar-ft">\n        <span class="toolbar-text-right">共{{totalCount}}条记录，每页{{pageSize}}条</span>\n        <i class="{{#if isFirst}}icon-grid-page-first-disabled{{else}}icon-grid-page-first{{/if}}" data-role="first"></i>\n        <i class="{{#if hasPrev}}icon-grid-page-prev{{else}}icon-grid-page-prev-disabled{{/if}}" data-role="prev"></i>\n        <i class="toolbar-separator"></i>\n        <span class="toolbar-text">当前第</span>\n        <input style="width:40px;" type="text" data-role="num">\n        <span class="toolbar-text">/{{pageNumbers}}页</span>\n        <i class="toolbar-separator"></i>\n        <i class="{{#if hasNext}}icon-grid-page-next{{else}}icon-grid-page-next-disabled{{/if}}" data-role="next"></i>\n        <i class="{{#if isLast}}icon-grid-page-last-disabled{{else}}icon-grid-page-last{{/if}}" data-role="last"></i>\n        <i class="toolbar-separator"></i>\n        <i class="icon-grid-refresh" data-role="refresh"></i>\n      </div>\n    {{/if}}\n  </div>\n</div>\n'),define("kjui/grid/1.3.0/extraHeaderTd.tpl",[],'{{#if needCheckbox}}\n  <td class="grid-cell" width="{{checkboxWidth}}"{{#if needRowspan}} rowspan="{{rowspan}}"{{/if}}>\n    <input type="checkbox" data-role="checkAll"/>\n  </td>\n{{/if}}\n{{#if needOrder}}\n  <td class="grid-cell" width="{{orderWidth}}"{{#if needRowspan}} rowspan="{{rowspan}}"{{/if}}></td>\n{{/if}}\n'),define("kjui/grid/1.3.0/headerTd.tpl",[],'{{#each headers}}\n  <td class="grid-cell{{addSortClass sort}}{{#if sort}} grid-is-sortable{{/if}}"\n    {{#if name}} data-name="{{name}}"{{/if}}\n    {{#if rowspan}} rowspan="{{rowspan}}"{{/if}}\n    {{#if colspan}} colspan="{{colspan}}"{{/if}}\n    ><span>{{header}}</span>\n  </td>\n{{/each}}\n'),define("kjui/grid/1.3.0/body.tpl",[],'{{#each records}}\n  <tr class="grid-row{{#if isAlt}} grid-row-alt{{/if}}">\n    {{#if ../needCheckbox}}\n      <td class="grid-cell grid-mark-cell">\n        <input type="checkbox" data-role="check"/>\n      </td>\n    {{/if}}\n    {{#if ../needOrder}}\n      <td class="grid-cell grid-mark-cell">\n        {{order}}\n      </td>\n    {{/if}}\n    {{#each values}}\n      <td class="grid-cell"{{#if align}} style="text-align:{{align}};"{{/if}}>\n        {{{value}}}\n      </td>\n    {{/each}}\n  </tr>\n{{/each}}\n');
